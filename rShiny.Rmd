---
title: "ShinyApp"
author: "Khanh Do, Joyce Gill, Billings-Chiu, Matthew"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo = F, include = F}
library(dplyr)
library(ggplot2)
library(shiny)
library(tidyverse)
library(tidyr)
library(plotly)
library(DT)
```

# Introduction and Research Motivation

This project explores higher education data from U.S. colleges to uncover trends related to **admissions selectivity, student body diversity, and institutional outcomes** such as graduation rates. The goal is to build an interactive Shiny app to help users â€” such as students and parents compare colleges based on customizable filters like state, admission rates, SAT scores, demographics, and more. Our dataset is from the U.S. Department of Education College Scorecard's Most Recent Institution-Level Data File. 

[Data Source - Most Recent Institution-Level Data](https://collegescorecard.ed.gov/data)

# Data Cleaning

```{r echo = F, include = F}
feature1data <- read.csv("cleaned_feature1data.csv")
feature2data <- read.csv("cleaned_feature2data.csv")
# feature3data <- read.csv("cleaned_feature3data.csv")
```

## TODO:

Use csv cleaned data instead of processing data in this file.

Make all features into 1 shiny app instead of 3 shiny apps like right now.

```{r echo = F, include = F}
## Set up the UI object
ui <- navbarPage("College Navigator",
         tabPanel("Racial Composition by Institution",
            sidebarLayout(position = "right",
               sidebarPanel(
                  selectInput("selected_inst", "Select Institution:",
                              choices = sort(unique(feature1data$INSTNM)),
                              selected = "Grinnell College")
                ),
            mainPanel(
                plotlyOutput('racePie')
                     )
                )
         ),
        tabPanel("College Finder",
          sidebarLayout(
            sidebarPanel(
              checkboxInput("use_sat", "Filter by SAT Average", value = FALSE),
              conditionalPanel(
                condition = "input.use_sat == true",
                sliderInput("sat_range", "SAT Average Range:", min = 400, max = 1600, value = c(1000, 1400))
              ),
              checkboxInput("use_adm", "Filter by Admission Rate", value = FALSE),
              conditionalPanel(
                condition = "input.use_adm == true",
                sliderInput("adm_range", "Admission Rate Range:", min = 0, max = 1, value = c(0.3, 0.8), step = 0.01)
              ),
              checkboxGroupInput("pub_filter", "Institution Type:",
                                 choices = list("Public" = 1, "Private" = 0)),
              checkboxGroupInput("locale_filter", "Locale:",
                                 choices = list("Suburb/City" = 1, "Rural/Town" = 0)),
              actionButton("show_result", "Show Result", class = "btn-success")
            ),
            mainPanel(
              plotlyOutput("college_plot"),
              dataTableOutput("school_info"),
              uiOutput("school_link")
            )
        )
     )
)

## Set up the server function
server <- function(input, output){
  output$racePie <- renderPlotly({
    selected_data <- feature1data %>%
      filter(INSTNM == input$selected_inst)
    race_labels <- c("White", "Black", "Hispanic", "Asian", "American Indian/Alaska Native", "Native Hawaiian/Pacific Islander",
                     "Two or More", "Non-Resident Alien", "Unknown")
    
    race_columns <- c("UGDS_WHITE", "UGDS_BLACK", "UGDS_HISP", "UGDS_ASIAN",
                      "UGDS_AIAN", "UGDS_NHPI", "UGDS_2MOR", "UGDS_NRA", "UGDS_UNKN")
    
    race_values <- as.numeric(selected_data[1, race_columns])
    
    valid_indices <- !is.na(race_values) & race_values > 0
    race_labels <- race_labels[valid_indices]
    race_values <- race_values[valid_indices]

    plot_ly(
      labels = race_labels,
      values = race_values,
      type = "pie"
    ) %>%
      layout(title = paste("Racial Composition of", input$selected_inst))
  })
  filtered_data <- eventReactive(input$show_result, {
    df <- feature2data

    if (length(input$pub_filter) > 0) {
      df <- df %>% filter(IS_PUBLIC %in% as.numeric(input$pub_filter))
    }

    if (length(input$locale_filter) > 0) {
      df <- df %>% filter(IS_CITY %in% as.numeric(input$locale_filter))
    }

    if (input$use_sat) {
      df <- df %>% filter(!is.na(SAT_AVG), SAT_AVG >= input$sat_range[1], SAT_AVG <= input$sat_range[2])
    }

    if (input$use_adm) {
      df <- df %>% filter(!is.na(ADM_RATE), ADM_RATE >= input$adm_range[1], ADM_RATE <= input$adm_range[2])
    }

    if (nrow(df) == 0) {
      showNotification("No results found based on current filters.", type = "error")
      return(data.frame())
    }

    return(df)
  })

  output$college_plot <- renderPlotly({
    df <- filtered_data()

    if (!is.data.frame(df) || nrow(df) == 0) {
      return(NULL)
    }

    df <- df %>%
      mutate(
        SAT_AVG = as.numeric(SAT_AVG),
        ADM_RATE = as.numeric(ADM_RATE)
      ) %>%
      filter(!is.na(SAT_AVG), !is.na(ADM_RATE))

    plot_ly(
      data = df,
      x = ~SAT_AVG,
      y = ~ADM_RATE,
      type = 'scatter',
      mode = 'markers',
      text = ~paste(
        "School:", INSTNM,
        "<br>SAT:", SAT_AVG,
        "<br>Adm Rate:", round(ADM_RATE, 3)
      ),
      hoverinfo = 'text',
      marker = list(color = 'rgba(0, 102, 204, 0.6)', size = 10)
    ) %>%
    layout(
      title = "Colleges: SAT vs Admission Rate",
      xaxis = list(title = "Average SAT Score"),
      yaxis = list(title = "Admission Rate"),
      annotations = list(
        x = 0.5, y = 1,  # Positioning the subtitle
        text = "Hover over and click on a point to see details about the school.",
        showarrow = FALSE,
        font = list(size = 14),
        align = 'center',
        xref = 'paper', yref = 'paper'
      )
    )
  })

  # Show selected school info when user clicks a point
    output$school_info <- renderDT({
      event <- event_data("plotly_click")
      df <- filtered_data()

      if (is.null(event) || nrow(df) == 0) return(NULL)

      # Find the clicked school
      clicked <- df %>%
        mutate(
          SAT_AVG = as.numeric(SAT_AVG),
          ADM_RATE = as.numeric(ADM_RATE)
        ) %>%
        filter(SAT_AVG == event$x, ADM_RATE == event$y)

      if (nrow(clicked) == 0) return(NULL)

      # Select the relevant columns to display in the table
      clicked %>%
        select(School = INSTNM, SAT_Avg = SAT_AVG, Admission_Rate = ADM_RATE) %>%
        datatable(
          options = list(
            pageLength = 5,      # Number of rows per page
            dom = 't',           # Only show the table (remove search and entries)
            searching = FALSE,   # Disable the search bar
            lengthChange = FALSE # Remove the "Show entries" dropdown
          )
        )
    })

  # Show clickable URL
  output$school_link <- renderUI({
    event <- event_data("plotly_click")
    df <- filtered_data()

    if (is.null(event) || nrow(df) == 0) return(NULL)

    clicked <- df %>%
      mutate(
        SAT_AVG = as.numeric(SAT_AVG),
        ADM_RATE = as.numeric(ADM_RATE)
      ) %>%
      filter(SAT_AVG == event$x, ADM_RATE == event$y)

    if (nrow(clicked) == 0) return(NULL)

    tags$a(
      href = ifelse(grepl("^https?://", clicked$INSTURL), clicked$INSTURL, paste0("https://", clicked$INSTURL)),
      target = "_blank",
      "Visit School Website"
    )
  })
}


## Build and run the 
shinyApp(ui, server)
```

## Feature 1

Users will be able to select an institution and view its racial composition through a Plotly pie chart, using variables like `UGDS_WHITE`, `UGDS_BLACK`, `UGDS_HISP`, `UGDS_ASIAN`, and more. The chart will display raw percentages when hovering over each slice, giving a quick and clear breakdown of the student body.

## Feature 2

The app will feature sliders for SAT average and admission rate (in ranges), along with filters for state and institution `CONTROL` type (Public = 1, Private = 2 or 3),  Locale (by rural & town, suburb & city) . Based on the user's selections, the app will return a list of colleges that meet the criteria in the form of a scatter plot with x-axis is the SAT average and y-axis is the Admission rate, where on hover the point, it shows the information, on click, user can click on the school website link. User will also have the option to tick whether they want to include criteria SAT, Admission rate. For Locale and IS_PUBLIC, they can also not tick any box or all boxes. The sliders for SAT and Admission rate would have a start and end pointer to show the range in which they want to filter for.

## Feature 3

The app will include a plot that allows users to filter colleges based on median student debt, median earnings, undergraduate enrollment, admission rate, and ACT average (calculated from subject scores using data manipulation). After selecting a college of interest, the app will use clustering techniques to identify and visualize similar institutions, helping users explore comparable schools based on these key financial and academic attributes.

## One Relevant Finding

We used our app to choose a college. Some of the characteristics we were looking for in a college were: SAT Average Range (1485 - 1600), Admission Rate Range (0 - 0.2), Private Institution, and Rural/Town Location. We first used Feature 2: College Finder to narrow down our list. Based on Feature 2, it seemed like Dartmouth College, Williams College, Bowdoin College, Washington and Lee University, Colby College,  Middlebury College, and Grinnell College. We then used Feature 1: Racial Composition by Institution. While most of the colleges had relatively similar racial compositions, Washington and Lee University was the least diverse by a large margin, so we decided to remove Washington and Lee University from our list of colleges.